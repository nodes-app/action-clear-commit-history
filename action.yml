name: Clear Commit History
description: Clears Commit History of GitHub Repository
branding:
  icon: x
  color: gray-dark
inputs:
  repository:
    description: Repository (username/repo_name)
    required: true
  location:
    description: Path to local copy
    required: false
  commit-message: 
    description: Recommit commit message
    required: true
    default: Initial commit
  keep-contents:
    description: Keep current contents including uncommitted changes (enabled by default)
    required: true
    default: 'true'
  token:
    description: Personal Access Token
    required: true
  
runs:
  using: composite
  steps:

    - name: User Info
      id: user-info
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
      run: |
        info=$(
          gh api \
            -H "Accept: application/vnd.github+json" \
            /user \
            --jq \
              '
              .login as $username
              | .id as $id
              | (
                if .email == null then (
                  ($id | tostring) + "+" + $username + "@users.noreply.github.com"
                ) else (
                  .email
                ) end
              ) as $public_email
              | 
              {
                "username": $username,
                "public_email": $public_email
              }
              '
        )
        echo "::set-output name=username::$(echo "$info" | jq -r '.username')"
        echo "::set-output name=public-email::$(echo "$info" | jq -r '.public_email')"

    - name: Create Temporary Copy
      id: temp-copy
      shell: bash
      env:
        REPOSITORY: ${{ inputs.repository }}
        LOCATION: ${{ inputs.location }}
        GITHUB_TOKEN: ${{ inputs.token }}
      run: |
        directory=$(mktemp -d)

        if [ "$LOCATION" = '' ]; then
          git clone --depth 1 "https://$GITHUB_TOKEN@github.com/$REPOSITORY.git" "$directory"
        else
          cp -r "$LOCATION/." "$directory"
        fi
        
        echo "::set-output name=directory::$directory"

    - name: Delete Contents
      if: inputs.keep-contents != 'true'
      shell: bash
      env:
        REPOSITORY: ${{ inputs.repository }}
        DIRECTORY: ${{ steps.temp-copy.outputs.directory }}
      run: |
        rm -rf "$DIRECTORY/*"
        echo "# $(basename "$REPOSITORY")" > "$DIRECTORY/README.md"

    - name: Clear Commit History
      shell: bash
      env:
        REPOSITORY: ${{ inputs.repository }}
        DIRECTORY: ${{ steps.temp-copy.outputs.directory }}
        KEEP_CONTENTS: ${{ inputs.keep-contents }}
        COMMIT_MESSAGE: ${{ inputs.commit-message }}
        USERNAME: ${{ steps.user-info.outputs.username }}
        EMAIL: ${{ steps.user-info.outputs.public-email }}
        GITHUB_TOKEN: ${{ inputs.token }}
      run: |
        # Source: https://stackoverflow.com/questions/9683279/make-the-current-commit-the-only-initial-commit-in-a-git-repository

        cd "$DIRECTORY"

        default_branch=$(gh repo view "$REPOSITORY" --json defaultBranchRef --jq '.defaultBranchRef.name')

        rm -rf .git

        git init -b "$default_branch"
        git config user.email "$EMAIL"
        git config user.name "$USERNAME"

        git add .
        git commit -m "$COMMIT_MESSAGE"
        git push -u --force "https://$GITHUB_TOKEN@github.com/$REPOSITORY.git" "$default_branch"

        cd -

    - name: Delete Temporary Copy
      shell: bash
      env:
        DIRECTORY: ${{ steps.temp-copy.outputs.directory }}
      run: rm -rf "$DIRECTORY"
